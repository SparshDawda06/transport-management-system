{% extends 'base.html' %}
{% block title %}Order Details - TMS{% endblock %}
{% block content %}
<div class="detail-container">
  <div class="detail-header">
    <div>
      <h1 class="detail-title">Order #{{ order.id }}</h1>
      <p class="detail-subtitle">{{ order.date.strftime('%B %d, %Y at %I:%M %p') }}</p>
    </div>
    <div class="detail-actions">
      <a href="{{ url_for('orders.edit_order', order_id=order.id) }}" class="btn btn-primary">
        <i class="fas fa-edit"></i> Edit
      </a>
      <button onclick="printOrder()" class="btn btn-info">
        <i class="fas fa-print"></i> Print
      </button>
      <button onclick="deleteOrder({{ order.id }})" class="btn btn-danger">
        <i class="fas fa-trash"></i> Delete
      </button>
      <a href="{{ url_for('orders.list_orders') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to List
      </a>
    </div>
  </div>
  
  <div class="detail-content">
    <!-- Basic Information -->
    <div class="detail-section">
      <h2 class="detail-section-title">Basic Information</h2>
      <div class="detail-grid">
        <div class="detail-label">Order ID</div>
        <div class="detail-value">{{ order.id }}</div>
      </div>
      <div class="detail-grid">
        <div class="detail-label">Date</div>
        <div class="detail-value">{{ order.date.strftime('%B %d, %Y') }}</div>
      </div>
      <div class="detail-grid">
        <div class="detail-label">Firm</div>
        <div class="detail-value">{{ order.firm or 'Not specified' }}</div>
      </div>
      <div class="detail-grid">
        <div class="detail-label">Order Type</div>
        <div class="detail-value">
          <span class="status-badge {{ 'status-active' if order.order_type == 'PARTY' else 'status-on-sale' }}">
            {{ order.order_type }}
          </span>
        </div>
      </div>
      <div class="detail-grid">
        <div class="detail-label">Status</div>
        <div class="detail-value">
          <span class="status-badge {{ 'status-active' if order.status == 'confirmed' else 'status-pending' if order.status == 'dispatched' else 'status-inactive' }}">
            {{ order.status.title() }}
          </span>
        </div>
      </div>
    </div>

    <!-- Route Information -->
    <div class="detail-section">
      <h2 class="detail-section-title">Route Information</h2>
      <div class="detail-grid">
        <div class="detail-label">From Station</div>
        <div class="detail-value">{{ order.from_station.name if order.from_station else 'Not specified' }}</div>
      </div>
      <div class="detail-grid">
        <div class="detail-label">To Station</div>
        <div class="detail-value">{{ order.to_station.name if order.to_station else 'Not specified' }}</div>
      </div>
    </div>

    <!-- Party Information -->
    {% if order.order_type == 'PARTY' %}
    <div class="detail-section">
      <h2 class="detail-section-title">Party Information</h2>
      <div class="detail-grid">
        <div class="detail-label">Consignor</div>
        <div class="detail-value">{{ order.consignor.name if order.consignor else 'Not specified' }}</div>
      </div>
      {% if order.consignor_concerned_person %}
      <div class="detail-grid">
        <div class="detail-label">Consignor Contact</div>
        <div class="detail-value">{{ order.consignor_concerned_person.name }}{% if order.consignor_concerned_person.designation %} ({{ order.consignor_concerned_person.designation }}){% endif %}</div>
      </div>
      {% endif %}
      {% if order.consignor_phone_number %}
      <div class="detail-grid">
        <div class="detail-label">Consignor Phone</div>
        <div class="detail-value">{{ order.consignor_phone_number.phone_number }}</div>
      </div>
      {% endif %}
      <div class="detail-grid">
        <div class="detail-label">Consignee</div>
        <div class="detail-value">{{ order.consignee.name if order.consignee else 'Not specified' }}</div>
      </div>
      {% if order.consignee_concerned_person %}
      <div class="detail-grid">
        <div class="detail-label">Consignee Contact</div>
        <div class="detail-value">{{ order.consignee_concerned_person.name }}{% if order.consignee_concerned_person.designation %} ({{ order.consignee_concerned_person.designation }}){% endif %}</div>
      </div>
      {% endif %}
      {% if order.consignee_phone_number %}
      <div class="detail-grid">
        <div class="detail-label">Consignee Phone</div>
        <div class="detail-value">{{ order.consignee_phone_number.phone_number }}</div>
      </div>
      {% endif %}
    </div>
    {% else %}
    <div class="detail-section">
      <h2 class="detail-section-title">Agent Information</h2>
      <div class="detail-grid">
        <div class="detail-label">Booking Agent</div>
        <div class="detail-value">{{ order.booking_agent.name if order.booking_agent else 'Not specified' }}</div>
      </div>
      {% if order.agent_concerned_person %}
      <div class="detail-grid">
        <div class="detail-label">Agent Contact</div>
        <div class="detail-value">{{ order.agent_concerned_person.name }}{% if order.agent_concerned_person.designation %} ({{ order.agent_concerned_person.designation }}){% endif %}</div>
      </div>
      {% endif %}
      {% if order.agent_phone_number %}
      <div class="detail-grid">
        <div class="detail-label">Agent Phone</div>
        <div class="detail-value">{{ order.agent_phone_number.phone_number }}</div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Goods Information -->
    <div class="detail-section">
      <h2 class="detail-section-title">Goods Information</h2>
      <div class="detail-grid">
        <div class="detail-label">Goods</div>
        <div class="detail-value">{{ order.goods.description if order.goods else 'Not specified' }}</div>
      </div>
      <div class="detail-grid">
        <div class="detail-label">Weight</div>
        <div class="detail-value">{{ order.weight or 'Not specified' }} kg</div>
      </div>
      <div class="detail-grid">
        <div class="detail-label">Rate</div>
        <div class="detail-value">₹{{ order.rate or 'Not specified' }}</div>
      </div>
    </div>

    <!-- Financial Information -->
    <div class="detail-section">
      <h2 class="detail-section-title">Financial Information</h2>
      <div class="detail-grid">
        <div class="detail-label">Total Amount</div>
        <div class="detail-value">₹{{ (order.weight * order.rate) if order.weight and order.rate else 'Not calculated' }}</div>
      </div>
      {% if order.order_type == 'AGENT' %}
      <div class="detail-grid">
        <div class="detail-label">Agent Commission</div>
        <div class="detail-value">{{ order.agent_commission or 'Not specified' }}%</div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
function deleteOrder(orderId) {
  if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
    fetch(`/orders/${orderId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        TMS.showNotification('Order deleted successfully', 'success');
        setTimeout(() => {
          window.location.href = '/orders';
        }, 1500);
      } else {
        TMS.showNotification(data.message || 'Error deleting order', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      TMS.showNotification('Error deleting order', 'error');
    });
  }
}

function printOrder() {
  // Add print-specific styling
  const printStyles = document.createElement('style');
  printStyles.textContent = `
    @media print {
      body * { visibility: hidden; }
      .detail-container, .detail-container * { visibility: visible; }
      .detail-container { position: absolute; left: 0; top: 0; width: 100%; }
      .detail-actions { display: none !important; }
    }
  `;
  document.head.appendChild(printStyles);
  
  // Print the page
  window.print();
  
  // Remove the print styles after printing
  setTimeout(() => {
    document.head.removeChild(printStyles);
  }, 1000);
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Ctrl+P or Cmd+P for print
  if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
    e.preventDefault();
    printOrder();
  }
  
  // Escape key to go back
  if (e.key === 'Escape') {
    window.location.href = '/orders';
  }
});
</script>
{% endblock %}